From f43d4816a09af0946c13984cbc0acc1bfdf9843d Mon Sep 17 00:00:00 2001
From: Chen Li1 <li1.chen@intel.com>
Date: Thu, 27 Dec 2018 15:39:01 +0800
Subject: [PATCH 16/16] Enable incomming stats handler

---
 erizo/src/erizo/WebRtcConnection.cpp | 4 ++--
 erizo/src/erizo/rtp/StatsHandler.cpp | 8 ++++++++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/erizo/src/erizo/WebRtcConnection.cpp b/erizo/src/erizo/WebRtcConnection.cpp
index d7c3760..7060980 100644
--- a/erizo/src/erizo/WebRtcConnection.cpp
+++ b/erizo/src/erizo/WebRtcConnection.cpp
@@ -24,7 +24,7 @@
 // #include "rtp/RtpRetransmissionHandler.h"
 #include "rtp/RtcpFeedbackGenerationHandler.h"
 // #include "rtp/RtpPaddingRemovalHandler.h"
-// #include "rtp/StatsHandler.h"
+#include "rtp/StatsHandler.h"
 // #include "rtp/SRPacketHandler.h"
 // #include "rtp/SenderBandwidthEstimationHandler.h"
 // #include "rtp/LayerDetectorHandler.h"
@@ -330,7 +330,7 @@ void WebRtcConnection::initializePipeline() {
   // pipeline_->addFront(FecReceiverHandler());
   // pipeline_->addFront(LayerBitrateCalculationHandler());
   // pipeline_->addFront(QualityFilterHandler());
-  // pipeline_->addFront(IncomingStatsHandler());
+  pipeline_->addFront(IncomingStatsHandler());
   // pipeline_->addFront(RtpTrackMuteHandler());
   // pipeline_->addFront(RtpSlideShowHandler());
   // pipeline_->addFront(RtpPaddingGeneratorHandler());
diff --git a/erizo/src/erizo/rtp/StatsHandler.cpp b/erizo/src/erizo/rtp/StatsHandler.cpp
index e3284cd..92f6302 100644
--- a/erizo/src/erizo/rtp/StatsHandler.cpp
+++ b/erizo/src/erizo/rtp/StatsHandler.cpp
@@ -13,6 +13,8 @@ DEFINE_LOGGER(StatsCalculator, "rtp.StatsCalculator");
 DEFINE_LOGGER(IncomingStatsHandler, "rtp.IncomingStatsHandler");
 DEFINE_LOGGER(OutgoingStatsHandler, "rtp.OutgoingStatsHandler");
 
+const uint32_t AVG_LOSS_WINDOW = 10;
+
 void StatsCalculator::update(WebRtcConnection *connection, std::shared_ptr<Stats> stats) {
   if (!connection_) {
     connection_ = connection;
@@ -115,6 +117,12 @@ void StatsCalculator::processRtcpPacket(std::shared_ptr<DataPacket> packet) {
         getStatsInfo()[ssrc].insertStat("packetsLost", CumulativeStat{chead->getLostPackets()});
         getStatsInfo()[ssrc].insertStat("jitter", CumulativeStat{chead->getJitter()});
         getStatsInfo()[ssrc].insertStat("sourceSsrc", CumulativeStat{ssrc});
+
+        // Get average fraction loss (among AVG_LOSS_WINDOW fraction loss)
+        if (!getStatsInfo()[ssrc].hasChild("avgFractionLost")) {
+          getStatsInfo()[ssrc].insertStat("avgFractionLost", MovingAverageStat{AVG_LOSS_WINDOW});
+        }
+        getStatsInfo()[ssrc]["avgFractionLost"] += (chead->getFractionLost());
         break;
       case RTCP_Sender_PT:
         ELOG_DEBUG("RTP SR: Packets Sent %u, Octets Sent %u", chead->getPacketsSent(), chead->getOctetsSent());
-- 
2.7.4

